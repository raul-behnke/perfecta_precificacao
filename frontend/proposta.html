<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perfecta Energia Solar – Sistema de Propostas Comerciais</title>

  <!-- Bootstrap CSS (via CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background-color: #f8f9fa;
    }
    .navbar-brand img {
      height: 30px;
      margin-right: 8px;
    }
    .tab-pane {
      padding: 16px;
    }
    .form-control, .form-select {
      margin-bottom: 12px;
    }
    .tabs-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 24px;
    }
    .btn-footer {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <!-- ======================
       Navbar Superior
       ====================== -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center" href="#">
        <img src="https://dummyimage.com/30x30/ff8c00/ffffff.png&text=S" alt="Logo" />
        <span class="fw-bold">Perfecta Energia Solar</span>
      </a>
      <div class="d-flex align-items-center">
        <span class="me-2 text-secondary">Consultor:</span>
        <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center" style="width:32px; height:32px;">
          JS
        </div>
      </div>
    </div>
  </nav>

  <!-- ======================
       Cabeçalho e Ações
       ====================== -->
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="fw-bold">Gerenciamento de Propostas</h2>
        <p class="text-muted">Crie e gerencie propostas comerciais para sistemas de energia solar</p>
      </div>
      <div>
        <button class="btn btn-outline-primary me-2">+ Nova Proposta</button>
        <button class="btn btn-outline-secondary">Propostas</button>
      </div>
    </div>

    <!-- ======================
         Card com Abas de Seções
         ====================== -->
    <div class="tabs-card">
      <!-- Abas -->
      <ul class="nav nav-tabs mb-3" id="abasProposta" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-cliente" data-bs-toggle="tab" data-bs-target="#cliente" type="button" role="tab">Cliente</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-negocio" data-bs-toggle="tab" data-bs-target="#negocio" type="button" role="tab">Negócio</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-detalhes" data-bs-toggle="tab" data-bs-target="#detalhes" type="button" role="tab">Detalhes</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-consumo" data-bs-toggle="tab" data-bs-target="#consumo" type="button" role="tab">Consumo</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-equipamentos" data-bs-toggle="tab" data-bs-target="#equipamentos" type="button" role="tab">Equipamentos</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-comercial" data-bs-toggle="tab" data-bs-target="#comercial" type="button" role="tab">Comercial</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-observacoes" data-bs-toggle="tab" data-bs-target="#observacoes" type="button" role="tab">Observações</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-resumo" data-bs-toggle="tab" data-bs-target="#resumo" type="button" role="tab">Resumo</button>
        </li>
      </ul>

      <!-- Conteúdo de cada Aba -->
      <div class="tab-content" id="conteudoAbas">
        <!-- ====== Aba: Cliente ====== -->
        <div class="tab-pane fade show active" id="cliente" role="tabpanel" aria-labelledby="tab-cliente">
          <h5 class="mb-3">Dados do Cliente</h5>
          <div class="row">
            <div class="col-md-6">
              <label for="nome_cliente" class="form-label">Nome Completo <span class="text-danger">*</span></label>
              <input type="text" id="nome_cliente" class="form-control" placeholder="Digite o nome completo do cliente" />
            </div>
            <div class="col-md-6">
              <label for="telefone_cliente" class="form-label">Telefone <span class="text-danger">*</span></label>
              <input type="tel" id="telefone_cliente" class="form-control" placeholder="(XX) XXXXX-XXXX" />
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <label for="origem_contato" class="form-label">Origem do Contato</label>
              <select id="origem_contato" class="form-select">
                <option value="">Selecione a origem</option>
                <option value="Indicação">Indicação</option>
                <option value="Site">Site</option>
                <option value="Prospecção Ativa">Prospecção Ativa</option>
                <option value="Outros">Outros</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="cidade_cliente" class="form-label">Cidade <span class="text-danger">*</span></label>
              <input type="text" id="cidade_cliente" class="form-control" placeholder="Digite a cidade" />
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <label for="cpf_cliente" class="form-label">CPF</label>
              <input type="text" id="cpf_cliente" class="form-control" placeholder="XXX.XXX.XXX-XX" />
            </div>
            <div class="col-12">
              <label for="endereco_cliente" class="form-label">Endereço</label>
              <textarea id="endereco_cliente" class="form-control" rows="2" placeholder="Rua, número, bairro, CEP..."></textarea>
            </div>
          </div>
        </div>

        <!-- ====== Aba: Negócio ====== -->
        <div class="tab-pane fade" id="negocio" role="tabpanel" aria-labelledby="tab-negocio">
          <h5 class="mb-3">Dados do Negócio</h5>
          <div class="row">
            <div class="col-md-6">
              <label for="titulo_negocio" class="form-label">Título da Oportunidade</label>
              <input type="text" id="titulo_negocio" class="form-control" placeholder="Ex: Projeto Solar João - Joinville" />
            </div>
            <div class="col-md-6">
              <label for="consultor_negocio" class="form-label">Consultor Responsável</label>
              <input type="text" id="consultor_negocio" class="form-control" placeholder="Nome do consultor" value="João Silva" />
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <label for="anexo_fatura" class="form-label">Anexo da Fatura de Energia</label>
              <input type="file" id="anexo_fatura" class="form-control" />
            </div>
            <div class="col-md-6">
              <label for="concessionaria" class="form-label">Concessionária</label>
              <select id="concessionaria" class="form-select">
                <option value="">Selecione</option>
                <option value="CELESC-DIS">CELESC-DIS</option>
                <option value="COELBA">COELBA</option>
                <option value="ENEL">ENEL</option>
              </select>
            </div>
          </div>
        </div>

        <!-- ====== Aba: Detalhes ====== -->
        <div class="tab-pane fade" id="detalhes" role="tabpanel" aria-labelledby="tab-detalhes">
          <h5 class="mb-3">Detalhes Adicionais</h5>
          <div class="row">
            <div class="col-12">
              <label for="outros_detalhes" class="form-label">Outros Detalhes / Observações de Negócio</label>
              <textarea id="outros_detalhes" class="form-control" rows="3" placeholder="Descreva detalhes adicionais..."></textarea>
            </div>
          </div>
        </div>

        <!-- ====== Aba: Consumo ====== -->
        <div class="tab-pane fade" id="consumo" role="tabpanel" aria-labelledby="tab-consumo">
          <h5 class="mb-3">Dados de Consumo</h5>
          <div class="row">
            <div class="col-md-6">
              <label for="consumo_medio_mensal" class="form-label">Consumo Médio Mensal (kWh) <span class="text-danger">*</span></label>
              <input
                type="number"
                step="any"
                id="consumo_medio_mensal"
                class="form-control"
                placeholder="Ex: 400"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="taxa_simultaneidade" class="form-label">Taxa de Simultaneidade (%)</label>
              <input
                type="number"
                step="any"
                id="taxa_simultaneidade"
                class="form-control"
                placeholder="Ex: 50"
                value="50"
              />
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <label for="indice_irrad" class="form-label">Índice de Irradiação (kWh/m²/dia) <span class="text-danger">*</span></label>
              <input
                type="number"
                step="any"
                id="indice_irrad"
                class="form-control"
                placeholder="Ex: 3.79"
                value="3.79"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="taxa_desempenho" class="form-label">Taxa de Desempenho (%) <span class="text-danger">*</span></label>
              <input
                type="number"
                step="any"
                id="taxa_desempenho"
                class="form-control"
                placeholder="Ex: 80"
                value="80"
                required
              />
            </div>
          </div>
        </div>

        <!-- ====== Aba: Equipamentos ====== -->
        <div class="tab-pane fade" id="equipamentos" role="tabpanel" aria-labelledby="tab-equipamentos">
          <h5 class="mb-3">Configuração de Equipamentos</h5>
          <div class="row">
            <div class="col-md-6">
              <label for="potencia_modulos_w" class="form-label">Potência dos Módulos (W) <span class="text-danger">*</span></label>
              <input
                type="number"
                step="any"
                id="potencia_modulos_w"
                class="form-control"
                placeholder="Ex: 585"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="potencia_sistema_kw" class="form-label">Potência do Sistema (kW) <span class="text-danger">*</span></label>
              <input
                type="number"
                step="any"
                id="potencia_sistema_kw"
                class="form-control"
                placeholder="Ex: 4.68"
                required
              />
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <label for="quantidade_modulos" class="form-label">Quantidade de Módulos</label>
              <input
                type="number"
                id="quantidade_modulos"
                class="form-control"
                placeholder="(preenchido automaticamente)"
                disabled
              />
            </div>
          </div>
          <hr />
          <h6 class="mt-3">Custos dos Itens</h6>
          <div class="row">
            <div class="col-md-4">
              <label for="custo_unitario_modulo" class="form-label">Custo Unitário do Módulo (R$)</label>
              <input
                type="number"
                step="any"
                id="custo_unitario_modulo"
                class="form-control"
                value="1000"
              />
            </div>
            <div class="col-md-4">
              <label for="quantidade_inversor" class="form-label">Quantidade de Inversor</label>
              <input
                type="number"
                id="quantidade_inversor"
                class="form-control"
                value="1"
              />
            </div>
            <div class="col-md-4">
              <label for="custo_unitario_inversor" class="form-label">Custo Unitário do Inversor (R$)</label>
              <input
                type="number"
                step="any"
                id="custo_unitario_inversor"
                class="form-control"
                value="3000"
              />
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <label for="custo_estrutura" class="form-label">Custo de Estrutura (R$)</label>
              <input
                type="number"
                step="any"
                id="custo_estrutura"
                class="form-control"
                value="500"
              />
            </div>
            <div class="col-md-6">
              <label for="custo_cabos" class="form-label">Custo de Cabos e Componentes (R$)</label>
              <input
                type="number"
                step="any"
                id="custo_cabos"
                class="form-control"
                value="200"
              />
            </div>
          </div>
        </div>

        <!-- ====== Aba: Comercial ====== -->
        <div class="tab-pane fade" id="comercial" role="tabpanel" aria-labelledby="tab-comercial">
          <h5 class="mb-3">Dados Comerciais / Financeiros</h5>
          <div class="row">
            <div class="col-md-6">
              <label for="custo_base_por_kw" class="form-label">Custo Base Instalação por kW (R$)</label>
              <input
                type="number"
                step="any"
                id="custo_base_por_kw"
                class="form-control"
                value="400"
              />
            </div>
            <div class="col-md-6">
              <label for="percentual_indiretos" class="form-label">Percentual de Custos Indiretos (%)</label>
              <input
                type="number"
                step="any"
                id="percentual_indiretos"
                class="form-control"
                value="5"
              />
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <label for="percentual_margem" class="form-label">Percentual de Margem de Lucro (%)</label>
              <input
                type="number"
                step="any"
                id="percentual_margem"
                class="form-control"
                value="20"
              />
            </div>
            <div class="col-md-6">
              <label for="aliquota_impostos" class="form-label">Alíquota de Impostos sobre Venda (%)</label>
              <input
                type="number"
                step="any"
                id="aliquota_impostos"
                class="form-control"
                value="15"
              />
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <label for="valor_adicional" class="form-label">Valor Adicional (R$)</label>
              <input
                type="number"
                step="any"
                id="valor_adicional"
                class="form-control"
                value="0"
              />
            </div>
            <div class="col-md-6">
              <label for="forma_desconto" class="form-label">Forma de Desconto</label>
              <select id="forma_desconto" class="form-select">
                <option value="Sem Desconto">Sem Desconto</option>
                <option value="Porcentagem">Porcentagem</option>
                <option value="Valor">Valor</option>
              </select>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <label for="valor_desconto" class="form-label">Valor do Desconto (se aplicável)</label>
              <input
                type="number"
                step="any"
                id="valor_desconto"
                class="form-control"
                value="0"
              />
            </div>
          </div>
        </div>

        <!-- ====== Aba: Observações ====== -->
        <div class="tab-pane fade" id="observacoes" role="tabpanel" aria-labelledby="tab-observacoes">
          <h5 class="mb-3">Observações Gerais</h5>
          <div class="row">
            <div class="col-12">
              <label for="observacoes_gerais" class="form-label">Observações da Proposta</label>
              <textarea id="observacoes_gerais" class="form-control" rows="4" placeholder="Insira observações ou condições especiais..."></textarea>
            </div>
          </div>
        </div>

        <!-- ====== Aba: Resumo ====== -->
        <div class="tab-pane fade" id="resumo" role="tabpanel" aria-labelledby="tab-resumo">
          <h5 class="mb-3">Resumo da Proposta</h5>
          <div id="valorResultado" class="alert alert-secondary">
            Aguarde o cálculo para ver aqui o valor final da proposta.
          </div>
          <div id="detalhamentoResumo" class="mt-3">
            <!-- Aqui você pode exibir um detalhamento opcional: quantidade de módulos, geração estimada etc. -->
          </div>
        </div>
      </div>

      <!-- ======================
           Botões de Ação (Footer do Card)
           ====================== -->
      <div class="mt-4 d-flex justify-content-end">
        <button class="btn btn-light btn-footer" id="btnSalvar">Salvar Rascunho</button>
        <button class="btn btn-primary btn-footer" id="btnCalcular">Calcular Preço Final</button>
        <button class="btn btn-warning btn-footer" id="btnGerarPDF">Gerar PDF</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS e dependências (Popper) via CDN -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ======================
       Script de Lógica e Fetch
       ====================== -->
  <script>
    document.getElementById("btnCalcular").addEventListener("click", async () => {
      // 1) Verificação de campos obrigatórios
      const obrigatorios = [
        { id: "consumo_medio_mensal",  label: "Consumo Médio Mensal" },
        { id: "indice_irrad",          label: "Índice de Irradiação" },
        { id: "taxa_desempenho",       label: "Taxa de Desempenho" },
        { id: "potencia_modulos_w",    label: "Potência dos Módulos" },
        { id: "potencia_sistema_kw",   label: "Potência do Sistema" }
      ];

      for (let campo of obrigatorios) {
        const elemento = document.getElementById(campo.id);
        if (!elemento.value || elemento.value.trim() === "") {
          alert(`Por favor, preencha o campo obrigatório: ${campo.label}.`);
          elemento.focus();
          return; // Sai da função sem continuar
        }
      }

      // 2) Desabilita o botão e limpa o resultado anterior
      const btn = document.getElementById("btnCalcular");
      btn.disabled = true;
      btn.textContent = "Calculando...";

      const resultadoDiv = document.getElementById("valorResultado");
      resultadoDiv.className = "alert alert-secondary";
      resultadoDiv.textContent = "Calculando...";

      // 3) Coleta valores do formulário
      const consumo          = parseFloat(document.getElementById("consumo_medio_mensal").value);
      const potenciaModulos  = parseFloat(document.getElementById("potencia_modulos_w").value);
      const potenciaSistema  = parseFloat(document.getElementById("potencia_sistema_kw").value);

      const custoModulo      = parseFloat(document.getElementById("custo_unitario_modulo").value) || 0;
      const qtdInversor      = parseInt  (document.getElementById("quantidade_inversor").value) || 0;
      const custoInversor    = parseFloat(document.getElementById("custo_unitario_inversor").value) || 0;
      const custoEstrutura   = parseFloat(document.getElementById("custo_estrutura").value) || 0;
      const custoCabos       = parseFloat(document.getElementById("custo_cabos").value) || 0;

      // Ajustes fixos a zero (já que não há input no HTML)
      const ajusteTelhas   = 0;
      const ajustePadrao   = 0;

      const percIndiretos    = (parseFloat(document.getElementById("percentual_indiretos").value) || 0) / 100;
      const percMargem       = (parseFloat(document.getElementById("percentual_margem").value) || 0) / 100;
      const aliquotaImp      = (parseFloat(document.getElementById("aliquota_impostos").value) || 0) / 100;
      const valorAdd         = parseFloat(document.getElementById("valor_adicional").value) || 0;

      const formaDesc        = document.getElementById("forma_desconto").value;
      const valorDesc        = parseFloat(document.getElementById("valor_desconto").value) || 0;

      const indiceIrrad      = parseFloat(document.getElementById("indice_irrad").value) || 0;
      const taxaDesempenho   = (parseFloat(document.getElementById("taxa_desempenho").value) || 0) / 100;

      // 4) Monta o objeto para o cálculo no back-end
      const payloadCalculo = {
        consumo_medio_mensal: consumo,
        potencia_modulos_w:   potenciaModulos,
        potencia_sistema_kw:  potenciaSistema,
        custo_unitario_modulo:    custoModulo,
        quantidade_inversor:      qtdInversor,
        custo_unitario_inversor:  custoInversor,
        custo_estrutura:          custoEstrutura,
        custo_cabos:              custoCabos,
        ajuste_telhas:            ajusteTelhas,
        ajuste_padrao_entrada:    ajustePadrao,
        percentual_indiretos:     percIndiretos,
        percentual_margem:        percMargem,
        aliquota_impostos:        aliquotaImp,
        valor_adicional:          valorAdd,
        forma_desconto:           formaDesc,
        valor_desconto:           valorDesc,
        indice_irrad:             indiceIrrad,
        taxa_desempenho:          taxaDesempenho
      };

      let valorFinal = 0;
      let qtdModulosCalc = 0;

      try {
        // 5) Chama o endpoint do back-end para calcular
        const resp = await fetch("http://127.0.0.1:8000/calcular", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payloadCalculo)
        });

        if (!resp.ok) {
          const erro = await resp.json();
          resultadoDiv.className = "alert alert-danger";
          resultadoDiv.textContent = "Erro: " + (erro.detail || resp.statusText);
          btn.disabled = false;
          btn.textContent = "Calcular Preço Final";
          return;
        }

        const data = await resp.json();
        valorFinal = data.valor_proposta;

        // 6) Calcula localmente a quantidade de módulos (mesma lógica do back-end)
        if (consumo > 0 && potenciaModulos > 0 && indiceIrrad > 0 && taxaDesempenho > 0) {
          const geracaoDiaria   = consumo / 30.0;
          const geracaoPorModulo = (potenciaModulos / 1000.0) * indiceIrrad * taxaDesempenho;
          qtdModulosCalc = Math.ceil(geracaoDiaria / geracaoPorModulo);
          document.getElementById("quantidade_modulos").value = qtdModulosCalc;
        }

        // 7) Exibe o resultado na aba "Resumo"
        resultadoDiv.className = "alert alert-success";
        resultadoDiv.textContent = `Valor da Proposta: R$ ${valorFinal.toFixed(2)}`;
        const tabResumo = new bootstrap.Tab(document.querySelector('#tab-resumo'));
        tabResumo.show();
      }
      catch (err) {
        console.error(err);
        resultadoDiv.className = "alert alert-danger";
        resultadoDiv.textContent = "Não foi possível conectar ao servidor.";
        btn.disabled = false;
        btn.textContent = "Calcular Preço Final";
        return;
      }
      finally {
        btn.disabled = false;
        btn.textContent = "Calcular Preço Final";
      }

      // 8) Agora, precisamos obter a URL do webhook via GET /config
      let webhookUrl = "";
      try {
        const respConfig = await fetch("http://127.0.0.1:8000/config");
        if (respConfig.ok) {
          const cfg = await respConfig.json();
          webhookUrl = cfg.webhook_url;
        } else {
          console.warn("Falha ao obter config do servidor:", respConfig.status);
        }
      }
      catch (err) {
        console.error("Erro ao buscar /config:", err);
      }

      // 9) Se obtivemos a URL, enviamos o payload resumido para o LeadConnectorHQ
      if (webhookUrl) {
        const payloadWebhook = {
          deal_id: "COLE_AQUI_SEU_DEAL_ID",       // substitua pelo ID real no GHL
          contact_id: "COLE_AQUI_SEU_CONTACT_ID", // substitua pelo ID real no GHL
          valor_proposta: valorFinal,
          quantidade_modulos: qtdModulosCalc,
          outros_campos: {
            cidade: document.getElementById("cidade_cliente").value || "",
            consumo: consumo
          }
        };

        // Dispara o POST ao LeadConnectorHQ
        try {
          const respHook = await fetch(webhookUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payloadWebhook)
          });
          if (!respHook.ok) {
            console.warn("Webhook retornou status", respHook.status);
          }
        }
        catch (err) {
          console.error("Falha ao enviar webhook externo:", err);
        }
      }
      else {
        console.warn("WEBHOOK_URL não definido; não enviando dados ao LeadConnectorHQ.");
      }
    });

    // Botão "Gerar PDF" (ainda sem implementação real)
    document.getElementById("btnGerarPDF").addEventListener("click", () => {
      alert("Funcionalidade de gerar PDF ainda não implementada.");
    });

    // Botão "Salvar Rascunho" (ainda sem implementação real)
    document.getElementById("btnSalvar").addEventListener("click", () => {
      alert("Salvar rascunho ainda não implementado.");
    });
  </script>
</body>
</html>
